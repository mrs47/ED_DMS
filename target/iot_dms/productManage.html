<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome CSS-->
    <link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.css" rel="stylesheet">
    <!-- Google fonts - Popppins for copy-->
    <link rel="stylesheet" href="fonts/iconfont.css">
    <!-- orion icons-->
    <link rel="stylesheet" href="css/orionicons.css">
    <!-- theme stylesheet-->
    <link rel="stylesheet" href="css/style.default.css" id="theme-stylesheet">
    <!-- Custom stylesheet - for your changes-->
    <link rel="stylesheet" href="css/custom.css">
    <!-- Favicon-->
    <link rel="shortcut icon" href="img/favicon.png">

    <link rel="stylesheet" href="//at.alicdn.com/t/font_1557432_f1au4sax4zc.css">
    <!-- JavaScript files-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/popper.js/umd/popper.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/jquery.cookie/jquery.cookie.js"></script>
    <script src="js/js.cookie.min.js"></script>
    <script src="js/front.js"></script>
</head>
<body>
<header class="header">
    <nav class="navbar navbar-expand-lg px-4 py-2 bg-white shadow"><a href="#"
                                                                      class="sidebar-toggler text-gray-500 mr-4 mr-lg-5 lead"><i
            class="fas fa-align-left"></i></a><a
            href="center.html" class="navbar-brand font-weight-bold text-uppercase text-base">产品管理</a>
        <ul class="ml-auto d-flex align-items-center list-unstyled mb-0">
            <li class="nav-item">
                <form id="searchForm" class="ml-auto d-none d-lg-block">
                    <div class="form-group position-relative mb-0">
                        <button type="submit" style="top: -3px; left: 0;"
                                class="position-absolute bg-white border-0 p-0"><i
                                class="o-search-magnify-1 text-gray text-lg"></i></button>
                        <input type="search" placeholder="搜索 ..."
                               class="form-control form-control-sm border-0 no-shadow pl-4">
                    </div>
                </form>
            </li>
            <li class="nav-item dropdown mr-3"><a id="notifications" href="http://example.com" data-toggle="dropdown"
                                                  aria-haspopup="true" aria-expanded="false"
                                                  class="nav-link dropdown-toggle text-gray-400 px-1"><i
                    class="fa fa-bell"></i><span class="notification-icon"></span></a>
                <div aria-labelledby="notifications" class="dropdown-menu"><a href="#" class="dropdown-item">

                    <div class="d-flex align-items-center">
                        <div class="icon icon-sm bg-green text-white"><i class="fas fa-envelope"></i></div>
                        <div class="text ml-2">
                            <p class="mb-0">你有6条消息</p>
                        </div>
                    </div>
                </a>
                </div>
            </li>
            <li class="nav-item dropdown ml-auto"><a id="userInfo" href="http://example.com" data-toggle="dropdown"
                                                     aria-haspopup="true" aria-expanded="false"
                                                     class="nav-link dropdown-toggle"><img src="img/avatar-6.jpg"
                                                                                           alt="Jason Doe"
                                                                                           style="max-width: 2.5rem;"
                                                                                           class="img-fluid rounded-circle shadow"></a>
                <div aria-labelledby="userInfo" class="dropdown-menu"><a href="#" class="dropdown-item"><strong
                        class="d-block text-uppercase headings-font-family" id="user"></strong></a>
                    <div class="dropdown-divider"></div>
                    <a href="personalcenter.html" class="dropdown-item">个人中心</a>
                    <div class="dropdown-divider"></div>
                    <a href="#" onclick="logout()" class="dropdown-item">退出</a>
                </div>
            </li>
        </ul>
    </nav>
</header>
<div class="d-flex align-items-stretch">
    <div id="sidebar" class="sidebar py-3">
        <div class="text-gray-400 text-uppercase px-3 px-lg-4 py-4 font-weight-bold small headings-font-family">MAIN
        </div>
        <ul class="sidebar-menu list-unstyled">
            <li class="sidebar-list-item"><a href="center.html" class="sidebar-link text-muted"><i
                    class="o-home-1 mr-3 text-gray"></i><span>监控中心</span></a></li>
            <li class="sidebar-list-item"><a href="productManage.html" class="sidebar-link text-muted active"><i
                    class="o-survey-1 mr-3 text-gray"></i><span>产品管理</span></a></li>
            <li class="sidebar-list-item"><a href="deviceManage.html" class="sidebar-link text-muted"><i
                    class="o-imac-screen-1 mr-3 text-gray"></i><span>设备管理</span></a></li>
            <li class="sidebar-list-item"><a href="#" data-toggle="collapse" data-target="#pages" aria-expanded="false"
                                             aria-controls="pages" class="sidebar-link text-muted"><i
                    class="o-wireframe-1 mr-3 text-gray"></i><span>服务</span></a>
                <div id="pages" class="collapse">
                    <ul class="sidebar-menu list-unstyled border-left border-primary border-thick">
                        <li class="sidebar-list-item"><a href="filehub.html" class="sidebar-link text-muted pl-lg-5"><i
                                class="o-survey-1 mr-3 text-gray"></i><span>文件仓库</span></a></li>
                        <li class="sidebar-list-item"><a href="softhub.html" class="sidebar-link text-muted pl-lg-5 "><i
                                class="o-imac-screen-1 mr-3 text-gray"></i><span>软件仓库</span></a></li>
                    </ul>
                </div>
            </li>
        </ul>
    </div>

    <div class="page-holder w-100 d-flex flex-wrap">
        <div class="container-fluid px-xl-5">
            <section class="py-3">
                <div class="row">
                    <div class="col-lg-12 mb-4">
                        <div class="card">
                            <div class="card-header ">
                                <div class="row mb-2">
                                    <h6 class="text-uppercase form-inline mb-0"> 产品列表 </h6>
                                    <button type="button" class="btn btn-primary ml-auto" data-toggle="modal"
                                            data-target="#myModal">新增产品
                                    </button>
                                    <div class="modal fade" id="myModal" tabindex="-1" data-backdrop="static"
                                         role="dialog"
                                         aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h4 class="text-base" id="myModalLabel">产品信息</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="form-horizontal ml-3" id="addForm">
                                                        <div class="form-group row">
                                                            <label class="col-sm-3 form-control-label py-2">产品名</label>
                                                            <div class="col-sm-9">
                                                                <input type="text" id="productname"
                                                                       class="form-control">
                                                                <small class="form-text text-muted ml-3" id="productnamestate"></small>
                                                            </div>
                                                        </div>
                                                        <div class="line"></div>
                                                        <div class="form-group row">
                                                            <label class="col-md-3 form-control-label py-2">类别</label>
                                                            <div class="col-md-9 select">
                                                                <select name="category" class="form-control" id="categories">
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="line"></div>
                                                        <div class="form-group row">
                                                            <label class="col-md-3 form-control-label py-2">Token</label>
                                                            <div class="col-md-9">
                                                                <div class="form-group">
                                                                    <div class="input-group mb-3">
                                                                        <input type="text" id="token"
                                                                               placeholder="长度为16位"
                                                                               aria-label="长度为16位"
                                                                               aria-describedby="button-addon2"
                                                                               class="form-control">
                                                                        <div class="input-group-append">
                                                                            <button id="button-addon2" type="button"
                                                                                    class="btn btn-primary">自动生成
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <small class="form-text text-muted ml-3" id="tokenState">Token用于设备于服务器认证和安全传输</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="line"></div>
                                                        <div class="form-group row">
                                                            <label class="col-md-3 form-control-label">备注:</label>
                                                            <textarea class="col-md-4 col-lg-8"
                                                                      data-test-id="description" name="remark"
                                                                      placeholder="请输入产品描述" data-meta="Field"
                                                                      id="Description" rows="4" maxlength="100"
                                                                      type="text" height="100%"></textarea>
                                                        </div>
                                                    </form>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-default" data-dismiss="modal">
                                                        关闭
                                                    </button>
                                                    <button type="button" class="btn btn-primary" disabled id="sub">
                                                        提交
                                                    </button>
                                                </div>
                                                </form>

                                            </div><!-- /.modal-content -->
                                        </div><!-- /.modal -->
                                    </div>
                                </div>
                                <div class="row">
                                    <input id="inlineFormInput" type="text" placeholder="关键字"
                                           class="mr-3 form-control col-lg-2 col-md-2">
                                    <button type="button" id="search" class="btn btn-outline-primary shadow col-lg-1 col-md-2">搜索
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-hover card-text">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>产品名</th>
                                        <th>ProductKey</th>
                                        <th>添加时间</th>
                                        <th>
                                            <div class="ml-5">操作</div>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="tBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="row col-lg-12">
                        <h7>每页显示8条</h7>
                        <nav aria-label="" class="ml-auto">
                            <ul class="pagination" id="pagenation">
                            </ul>
                        </nav>
                    </div>
                </div>
            </section>
        </div>
        <footer class="footer bg-white shadow align-self-end py-3 px-xl-5 w-100">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-6 text-center text-md-left text-primary">
                        <!-- 版权信息 -->
                        <p class="mb-2 mb-md-0"></p>
                    </div>

                </div>
            </div>
        </footer>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        var obj = $.cookie("USER");
        if (isEmpty(obj)) {
            $(location).attr('href', 'index.html');
        }else {
            var userInfo = $.parseJSON(obj);
            if (!isEmpty(userInfo)){
                $("#user").html(userInfo.data.userName);
            }
        }

      getPage();
      getCategory();
      $("#search").click(function () {
          var productName = $("#inlineFormInput").val();
          getPage(1,productName);
      });
      $("#button-addon2").click(function () {
          $("#token").val(getRandomString());
      })
      $("#productname").on("input",function () {
          var productName = $("#productname").val();
          if (productName.length <= 3 || productName.length >12){
              $("#sub").prop("disabled",true);
              $("#productnamestate").html("<p style='color:red'>产品名称必须大于3个字符小于12个字符</p>")
          }else {
              $.ajax({
                  type: "post",
                  url: "product/checkProductName.do",
                  data: {"productName":productName},
                  success: function (data) {
                      var obj = $.parseJSON(data);
                      if (obj.status == 1){
                          $("#productnamestate").html("<p style='color:green'>产品名称可用</p>")
                          $("#sub").prop("disabled",false);
                      }else if (obj.status == 10){
                          $(location).attr('href', 'index.html');
                      }else {
                          $("#sub").prop("disabled",true);
                          $("#productnamestate").html("<p style='color:red'>产品名称已存在</p>")
                      }
                  },
                  dataType: "text"
              });
          }
      });
      $("#token").on("input",function () {
            var token = $("#token").val();
            if (token.length < 16 ){
                $("#sub").prop("disabled",true);
                $("#tokenState").html("<p style='color:red'>Token小于16位</p>")
            }else if (token.length >16){
                $("#sub").prop("disabled",true);
                $("#tokenState").html("<p style='color:red'>Token大于于16位</p>")
            }else {
                $("#sub").prop("disabled",false);
                $("#tokenState").html("<p style='color:green'>Token可用</p>")
            }
        });
      $("#sub").click(function () {
            var token = $("#token").val();
            var productName = $("#productname").val();
            var category = $("#categories").val();
            var description = $("#Description").val();
            if (token.length != 16 ){
                $("#sub").prop("disabled",true);
                $("#tokenState").html("<p style='color:red'>Token不可用</p>")
            }else if (productName.length <= 3){
                $("#sub").prop("disabled",true);
                $("#productnamestate").html("<p style='color:red'>产品名称不可用</p>")
            }else {
                $("#sub").prop("disabled",false);
               $.ajax({
                   type: "post",
                   url: "product/addProduct.do",
                   data: {"productName":productName,"category":category,"token":token,"remark":description},
                   success: function (data) {
                       var obj = eval(data);
                       if (obj.status == 1){
                           $("#sub").prop("disabled",true);
                           $("#addForm").html("<div class='modal-body m-auto col-12'><h2 class='m-auto'>添加成功<i class='iconfont iconchenggong1 ml-2' style='color:green'></div></i></h2>");
                       }else if (obj.status == 10){
                           $(location).attr('href', 'index.html');
                       }else {
                           $("#sub").prop("disabled",true);
                           $("#addForm").html("<div class='modal-body m-auto col-12'><h2 class='m-auto'>添加失败<i class='iconfont iconcha m-auto' style='color:red'></i></h2>");
                       }
                   }
               });
            }
        });
    });
    function getCategory() {
      $.ajax({
        type: "post",
        url: "product/getCategory.do",
        success: function (data) {
          var pageInfo = $.parseJSON(data);
          $("#categories").html("");
          if (pageInfo.status==1){
              for (i = 0; i < pageInfo.data.length; i++) {
                  if (!isEmpty(pageInfo.data[i])) {
                      $("#categories").append("<option value=\""+pageInfo.data[i].categoryId+"\" >"+pageInfo.data[i].categoryName+"</option>");
                  }
              }
          }else if (obj.status == 10){
              $(location).attr('href', 'index.html');
          }
        },
        dataType: "text"
      });
    }
    function delProduct(id) {
        $.ajax({
            type: "post",
            url: "product/removeProduct.do",
            data: {"productId":id},
            success: function (data) {
                var obj = $.parseJSON(data);
                if (obj.status == 1){
                    alert("删除成功！");
                    getPage();
                }else if (obj.status == 10){
                    $(location).attr('href', 'index.html');
                }else {
                    alert("删除失败！");
                    getPage();
                }
            },
            dataType: "text"
        });
    }
    function getPage(page,name) {
      $.ajax({
        type: "post",
        url: "product/selectAll.do",
        data: {"page":page,"productName":name},
        success: function (data) {
          var pageInfo = $.parseJSON(data);
          $("#tBody").html("");
          if (pageInfo.status == 1 && !isEmpty(pageInfo.data.data)){
              for (i = 0; i < pageInfo.data.every; i++) {
                  if (!isEmpty(pageInfo.data.data[i])) {
                      $("#tBody").append(" <tr><th scope=\"row\">"
                          + i + "</th><td>"
                          + pageInfo.data.data[i].productName + "</td><td>"
                          + pageInfo.data.data[i].productKey + "</td><td>"
                          + pageInfo.data.data[i].createTime + "</td><td><a href=\"#\" onclick='getToken(\""+pageInfo.data.data[i].token+"\")' class=\"ml-2\">查看"
                          + "</a>&nbsp;<a href=\"deviceManage.html?productId="+pageInfo.data.data[i].productId+"\">管理设备</a>&nbsp;"
                          + "<a href=\"#\" onclick='delProduct(\""+pageInfo.data.data[i].productId+"\")' >删除</a></td></tr>");
                  }
              }
              $("#pagenation").html("");
              $("#pagenation").append("<li class=\"page-item\"><a class=\"page-link\" href=\"#\" onclick=\"getPage()\">首页</a></li>");
              $("#pagenation").append("<li class=\"page-item\"><a class=\"page-link\" href=\"#\"  onclick='getPage("+pageInfo.data.previousPage+")' aria-label=\"Previous\">\n" +
                  "                                    <span aria-hidden=\"true\">&laquo;</span>\n" +
                  "                                    <span class=\"sr-only\">上一页</span>\n" +
                  "                                </a></li>");
              for (i =1;i<= pageInfo.data.totalPage;i++){
                  $("#pagenation").append(" <li class=\"page-item\"><a class=\"page-link\" href=\"#\" onclick='getPage("+i+")' >"+i+"</a></li>");
              }
              $("#pagenation").append("<li class=\"page-item\"><a class=\"page-link\" href=\"#\"  onclick='getPage("+pageInfo.data.nextPage+")' aria-label=\"Next\">\n" +
                  "                                    <span aria-hidden=\"true\">&raquo;</span>\n" +
                  "                                    <span class=\"sr-only\">下一页</span>\n" +
                  "                                </a></li>");
              $("#pagenation").append("<li class=\"page-item\"><a class=\"page-link\" href=\"#\"  onclick='getPage("+pageInfo.data.endPage+")'>末页</a></li>");

          }else if (pageInfo.status == 10){
              $(location).attr('href', 'index.html');
          }
          },
        dataType: "text"
      });
    }

    function getToken(str) {
        alert("当前产品 Token:    "+str);
    }
    function getRandomString() {
        var $chars = '0123456789abcdefghijklmnopqrstuvwxyz!@#$%^&*/-+';
        var maxPos = $chars.length;
        var pwd = '';
        for (i = 0; i < 16; i++) {
            pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
        }
        return pwd.toLowerCase();
    }
    function isEmpty(obj) {
        if (typeof obj == "undefined" || obj == null || obj == "") {
            return true;
        } else {
            return false;
        }
    }
    function logout() {
        $.ajax({
            type: "post",
            url: "user/logout.do",
            success: function (data) {
                var obj = $.parseJSON(data)
                if(!isEmpty(obj) && obj.status==1){
                    $.cookie("USER",null);
                    $(location).attr('href','index.html');
                }
            },
            dataType: "text"
        });
        $.cookie("USER",null);
        $(location).attr('href','index.html');
    }
</script>
</body>

</html>